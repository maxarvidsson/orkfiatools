<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<title>spellchance</title>
<style type="text/css">
#result { font-size: 125%; font-weight: bold; }
</style>
<script type="text/javascript">
var INTEL = 1;
var DARK = 2;
var spells = [
    ["Inner Sight",      220, INTEL],
    ["Vision",           200, INTEL],
    ["Mystical Rust",    200, DARK],
    ["Poison",           180, DARK],
    ["Fear",             150, DARK],
    ["Fireball",         150, DARK],
    ["Lightning Bolt",   150, DARK],
    ["Meteor Storm",     130, DARK],
    ["Cyclops",          125, DARK],
    ["Wrath of XENE",    120, DARK],
    ["Earthquake",       100, DARK],
    ["Fly over",         100, INTEL],
    ["Rupture",           90, DARK],
    ["Enchantress Salem", 80, DARK],
    ["Winds of Distress", 80, DARK],
    ["DragonMage",        60, DARK],
    ["Enforced Honesty",  60, DARK],
    ["Juranimosity",      60, DARK],
    ["Magical Void",      60, DARK]
];

function main()
{
    var ml = Math.min(100, Math.max(1, document.getElementById('ml').value));
    var target = Math.min(100, Math.max(1, document.getElementById('target').value));
    var spell = document.getElementById('spell').value;
    var race = document.getElementById('race').value;
    var target_race = document.getElementById('target_race').value;
    var churches = Math.min(25, Math.max(0, document.getElementById('churches').value));
    var sod = document.getElementById('sod').checked;
    var size = Math.max(1, document.getElementById('size').value);
    var target_size = Math.max(1, document.getElementById('target_size').value);
    var sci = Math.min(25, Math.max(0, document.getElementById('sci').value));

    var race_fail = 0;
    var race_cast_fail = 0;
    var church_protection = 0.03;

    switch (race) {
        case 'nazgul':
            race_cast_fail = 0.25;
            break;
    }
    
    switch (target_race) {
        case 'nazgul':
            race_fail = 0.25;
            break;
    }

    var sci_fail = sci/100;
    var church_fail = churches*church_protection;
    var base = orkfiaSpellChance(ml, target, spells[spell][1]);
    var size_fail = 0;
    if (INTEL != spells[spell][2]) {
        size_fail = orkfiaSizePenalty(size, target_size);
    }
    var chance = base*(1-church_fail)*(1-sod*0.25)*(1-race_fail)*(1-race_cast_fail)*(1-sci_fail)*(1-size_fail);
    
    colorResult(chance);
    chance = Math.round(chance*10000)/100;
    
    document.getElementById('chance').innerHTML = chance + '%';
}

function orkfiaSpellChance(ml, tml, spell)
{
    return Math.min(spell*(ml+(ml>tml)*(ml-tml)+10)/(tml+10), 290)/300;
}

function orkfiaSizePenalty(s, t)
{
    if (s*2 < t) return 0.25;
    if (s*0.6 > t) return Math.min(0.6, 0.9-t/s);
    return 0;
}

function colorResult(d)
{
    var red = 255 - Math.round(d*255);
    var green = Math.min(255, Math.round(1.5 * d * 255));
    var rgb = 'rgb(' + red + ',' + green + ',0)';
    document.getElementById('chance').style.color = rgb;
}
</script>
</head>
<body>

<div id="top">
<input type="button" value="Calc" onclick="main();" />
<span id="result">
Chance: <span id="chance">0%</span>
</span>
</div>

<table>
<tr>
<td>Your ML:</td>
<td><input type="text" id="ml" size="5" onkeyup="main();" /></td>
</tr>
<tr>
<td>Target ML:</td>
<td><input type="text" id="target" size="5" onkeyup="main();" /></td>
</tr>
<tr>
<td colspan="2">
<select id="spell" onchange="main();">
<script type="text/javascript">
for (var i = 0; i < spells.length; i++) {
    document.write("<option value=\""+i+"\">"+spells[i][0]+"</option>");
}
</script>
</select>
</td>
</tr>

<tr>
<td>Your Race:</td>
<td><select id="race" onchange="main();">
<option value="default" selected="selected">Default</option>
<option value="nazgul">Nazgul</option>
</select></td>
</tr>

<tr>
<td>Target Race:</td>
<td><select id="target_race" onchange="main();">
<option value="default" selected="selected">Default</option>
<option value="nazgul">Nazgul</option>
</select></td>
</tr>

<tr>
<td>Your Size:</td>
<td><input type="text" id="size" size="5" value="" onkeyup="main();" /></td>
</tr>

<tr>
<td>Target Size:</td>
<td><input type="text" id="target_size" size="5" value="" onkeyup="main();" /></td>
</tr>

<tr>
<td>Churches(%):</td>
<td><input type="text" id="churches" size="5" value="0" onkeyup="main();" /></td>
</tr>

<tr>
<td>Combat(%):</td>
<td><input type="text" id="sci" size="5" value="0" onkeyup="main();" /></td>
</tr>

<tr>
<td>SoD: <input type="checkbox" id="sod" onchange="main();" /></td>
<td>&nbsp;</td>
</tr>

</table>

</body>
</html>
